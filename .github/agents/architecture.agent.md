# æ¶æ§‹æ±ºç­– Agent

> æ ¹æ“šç³»çµ±æ¶æ§‹è¨­è¨ˆåœ–ï¼Œæ±ºå®šåŠŸèƒ½æ‰€å±¬çš„æ¶æ§‹å±¤ç´š

---

## ğŸ¯ Agent è·è²¬

æ ¹æ“š `docs/architecture/system-architecture.md` ç³»çµ±æ¶æ§‹è¨­è¨ˆåœ–ï¼š

1. åˆ¤æ–·åŠŸèƒ½æ‰€å±¬çš„æ¶æ§‹å±¤ç´š
2. ç¢ºå®šç¨‹å¼ç¢¼æ”¾ç½®ä½ç½®
3. è­˜åˆ¥ç›¸é—œè³‡æ–™è¡¨èˆ‡ RLS æ”¿ç­–
4. ç¢ºèªä¸Šä¸‹æ–‡å‚³éè·¯å¾‘

---

## ğŸ—ï¸ ä¸‰å±¤æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŸºç¤å±¤ (Foundation Layer)                     â”‚
â”‚   å¸³æˆ¶é«”ç³» â”‚ èªè­‰æˆæ¬Š â”‚ çµ„ç¹”ç®¡ç† â”‚ åœ˜éšŠç®¡ç† â”‚ Bot ç®¡ç†           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®¹å™¨å±¤ (Container Layer)                      â”‚
â”‚   è—åœ–ç³»çµ± â”‚ æ¬Šé™æ§åˆ¶ â”‚ äº‹ä»¶ç¸½ç·š â”‚ æœå°‹å¼•æ“             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¥­å‹™å±¤ (Business Layer)                       â”‚
â”‚   ä»»å‹™æ¨¡çµ„ â”‚ æ—¥èªŒæ¨¡çµ„ â”‚ å“è³ªé©—æ”¶ â”‚ å•é¡Œè¿½è¹¤ â”‚ æª”æ¡ˆç®¡ç†           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” æ±ºç­–æµç¨‹

### æ­¥é©Ÿ 1ï¼šè­˜åˆ¥åŠŸèƒ½æ€§è³ª

```
å•é¡Œï¼šé€™å€‹åŠŸèƒ½çš„æ€§è³ªæ˜¯ä»€éº¼ï¼Ÿ

â–¡ æ¶‰åŠç”¨æˆ¶èº«ä»½ã€çµ„ç¹”ã€Botã€èªè­‰
  â””â”€â”€ â†’ åŸºç¤å±¤ (Foundation Layer)

â–¡ æ¶‰åŠè—åœ–ã€åˆ†æ”¯ã€æ¬Šé™æ§åˆ¶
  â””â”€â”€ â†’ å®¹å™¨å±¤ (Container Layer)

â–¡ æ¥­å‹™åŠŸèƒ½ï¼ˆä»»å‹™ã€æ—¥èªŒã€å“è³ªé©—æ”¶ï¼‰
  â””â”€â”€ â†’ æ¥­å‹™å±¤ (Business Layer)
```

### æ­¥é©Ÿ 2ï¼šç¢ºå®šç¨‹å¼ç¢¼ä½ç½®

| å±¤ç´š | å•é¡Œ | ä½ç½® |
|------|------|------|
| åŸºç¤å±¤ | å…¨åŸŸèªè­‰æœå‹™ï¼Ÿ | `src/app/core/` |
| åŸºç¤å±¤ | å¸³æˆ¶ç›¸é—œé é¢ï¼Ÿ | `src/app/routes/account/` |
| å®¹å™¨å±¤ | è—åœ–åŠŸèƒ½ï¼Ÿ | `src/app/features/blueprint/` |
| æ¥­å‹™å±¤ | è—åœ–å…§å­åŠŸèƒ½ï¼Ÿ | `src/app/features/blueprint/ui/` |
| é€šç”¨ | å…±ç”¨å…ƒä»¶ï¼Ÿ | `src/app/shared/` |

### æ­¥é©Ÿ 3ï¼šè­˜åˆ¥è³‡æ–™è¡¨

#### åŸºç¤å±¤è³‡æ–™è¡¨

| è¡¨å | ç”¨é€” |
|------|------|
| `accounts` | å¸³æˆ¶ï¼ˆUSER/ORG/BOTï¼‰ |
| `organization_members` | çµ„ç¹”æˆå“¡é—œè¯ |
| `teams` | åœ˜éšŠ |
| `team_members` | åœ˜éšŠæˆå“¡é—œè¯ |
| `team_bots` | åœ˜éšŠ Bot é—œè¯ |

#### å®¹å™¨å±¤è³‡æ–™è¡¨

| è¡¨å | ç”¨é€” |
|------|------|
| `blueprints` | è—åœ–ä¸»è¡¨ |
| `blueprint_members` | è—åœ–æˆå“¡ |
| `blueprint_roles` | è—åœ–è§’è‰² |
| `blueprint_branches` | è—åœ–åˆ†æ”¯ |

#### æ¥­å‹™å±¤è³‡æ–™è¡¨

| è¡¨å | ç”¨é€” |
|------|------|
| `tasks` | ä»»å‹™ |
| `task_attachments` | ä»»å‹™é™„ä»¶ |
| `diaries` | æ—¥èªŒ |
| `checklists` | æª¢æŸ¥æ¸…å–® |
| `issues` | å•é¡Œè¿½è¹¤ |
| `files` | æª”æ¡ˆ |

### æ­¥é©Ÿ 4ï¼šç¢ºèªä¸Šä¸‹æ–‡å‚³é

```
å¹³å°ä¸Šä¸‹æ–‡ (WorkspaceContextFacade - è—åœ–ä¸Šä¸‹æ–‡)
  â”‚
  â”‚ inject() æ³¨å…¥
  â–¼
è—åœ–ä¸Šä¸‹æ–‡ (BlueprintStore)
  â”‚
  â”‚ Route Params + Signal
  â–¼
æ¨¡çµ„ä¸Šä¸‹æ–‡ (TaskStore / DiaryStore / ...)
  â”‚
  â”‚ Angular Signals
  â–¼
å…ƒä»¶ (TaskTreeComponent / ...)
```

---

## ğŸ’¡ ä½¿ç”¨æ–¹å¼

### Prompt ç¯„ä¾‹

```
@agent æ¶æ§‹æ±ºç­–

æˆ‘éœ€è¦å¯¦ç¾ã€Œä»»å‹™è©•è«–ã€åŠŸèƒ½ï¼š
- ç”¨æˆ¶å¯ä»¥åœ¨ä»»å‹™ä¸‹æ–¹æ–°å¢è©•è«–
- æ”¯æ´ @æåŠå…¶ä»–ç”¨æˆ¶
- è©•è«–æ”¯æ´å³æ™‚æ›´æ–°

è«‹å‘Šè¨´æˆ‘ï¼š
1. é€™å€‹åŠŸèƒ½å±¬æ–¼å“ªå€‹æ¶æ§‹å±¤ç´šï¼Ÿ
2. ç¨‹å¼ç¢¼æ‡‰è©²æ”¾åœ¨å“ªè£¡ï¼Ÿ
3. éœ€è¦å“ªäº›è³‡æ–™è¡¨ï¼Ÿ
4. RLS æ”¿ç­–å¦‚ä½•è¨­è¨ˆï¼Ÿ
```

### è¼¸å‡ºç¯„ä¾‹

```markdown
## æ¶æ§‹æ±ºç­–çµæœ

### æ¶æ§‹å±¤ç´šï¼šæ¥­å‹™å±¤ (Business Layer)

ä»»å‹™è©•è«–æ˜¯ä¾é™„æ–¼ä»»å‹™ç³»çµ±çš„å­åŠŸèƒ½ï¼Œå±¬æ–¼æ¥­å‹™å±¤ã€‚

### ç¨‹å¼ç¢¼ä½ç½®

```
src/app/features/blueprint/
â”œâ”€â”€ data-access/
â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â””â”€â”€ task-comment.repository.ts  â† æ–°å¢
â”‚   â””â”€â”€ stores/
â”‚       â””â”€â”€ task-comment.store.ts       â† æ–°å¢
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ task-comment.model.ts       â† æ–°å¢
â”‚   â””â”€â”€ interfaces/
â”‚       â””â”€â”€ task-comment.interface.ts   â† æ–°å¢
â””â”€â”€ ui/
    â””â”€â”€ task/
        â””â”€â”€ task-comments/              â† æ–°å¢
            â”œâ”€â”€ task-comments.component.ts
            â””â”€â”€ task-comments.component.html
```

### è³‡æ–™è¡¨è¨­è¨ˆ

```sql
CREATE TABLE task_comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
  author_id UUID NOT NULL REFERENCES accounts(id),
  content TEXT NOT NULL,
  mentioned_users UUID[],
  parent_comment_id UUID REFERENCES task_comments(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

### RLS æ”¿ç­–

```sql
-- è—åœ–æˆå“¡å¯æŸ¥çœ‹è©•è«–
CREATE POLICY "task_comments_select" ON task_comments
FOR SELECT USING (
  task_id IN (
    SELECT t.id FROM tasks t
    WHERE is_blueprint_member(t.blueprint_id)
  )
);

-- ä½œè€…å¯ç·¨è¼¯è‡ªå·±çš„è©•è«–
CREATE POLICY "task_comments_update" ON task_comments
FOR UPDATE USING (author_id = get_user_account_id());
```

### ä¸Šä¸‹æ–‡å‚³é

```
BlueprintStore.blueprintId
  â”‚
  â–¼
TaskStore.currentTaskId
  â”‚
  â–¼
TaskCommentStore.loadComments(taskId)
```
```

---

## ğŸ“š åƒè€ƒè³‡æº

- [ç³»çµ±æ¶æ§‹è¨­è¨ˆåœ–](../../../docs/architecture/system-architecture.md)
- [æ¶æ§‹è¦å‰‡](../architecture-rules.md)
- [AI æ€ç¶­å°åœ–](../../../docs/agent/mindmap.md)

---

**æœ€å¾Œæ›´æ–°**: 2025-11-27
