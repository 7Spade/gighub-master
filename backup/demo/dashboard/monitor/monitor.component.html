<!-- 組織監控儀表板 -->
<div class="org-monitor-dashboard">
  <!-- 頂部標題區 -->
  <div class="monitor-header">
    <div class="header-content">
      <div class="header-left">
        <div class="header-icon">
          <i nz-icon nzType="cluster" nzTheme="outline"></i>
        </div>
        <div class="header-text">
          <h1>組織運營監控中心</h1>
          <p>全面追蹤組織運營狀況、部門績效與資源配置</p>
        </div>
      </div>
      <div class="header-right">
        <div class="status-badge success">
          <i nz-icon nzType="check-circle" nzTheme="fill"></i>
          系統運行正常
        </div>
        <div class="update-info">
          <span class="uptime">可用率: {{ systemUptime }}</span>
          <span class="update-time">更新於: {{ lastUpdateTime | date: 'HH:mm:ss' }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 組織 KPI -->
  <div nz-row [nzGutter]="[24, 24]" class="kpi-row">
    @for (kpi of orgKPIs; track kpi.id) {
      <div nz-col nzXs="24" nzSm="12" nzMd="12" nzLg="6">
        <nz-card [nzBordered]="false" class="kpi-card">
          <div class="kpi-header">
            <span class="kpi-name">{{ kpi.name }}</span>
            <span class="kpi-trend" [class.up]="kpi.trend === 'up'" [class.down]="kpi.trend === 'down'">
              @if (kpi.trend !== 'stable') {
                <i nz-icon [nzType]="kpi.trend === 'up' ? 'arrow-up' : 'arrow-down'" nzTheme="outline"></i>
                {{ kpi.trendValue }}%
              } @else {
                <i nz-icon nzType="minus" nzTheme="outline"></i>
                持平
              }
            </span>
          </div>
          <div class="kpi-value">
            {{ kpi.value | number }}
            <span class="kpi-unit">{{ kpi.unit }}</span>
          </div>
          <div class="kpi-progress">
            <div class="progress-label">
              <span>目標: {{ kpi.target | number }} {{ kpi.unit }}</span>
              <span>{{ getKPIProgress(kpi) }}%</span>
            </div>
            <nz-progress
              [nzPercent]="getKPIProgress(kpi)"
              [nzShowInfo]="false"
              nzSize="small"
              [nzStrokeColor]="getKPIProgress(kpi) >= 80 ? '#52c41a' : getKPIProgress(kpi) >= 60 ? '#1890ff' : '#faad14'"
            />
          </div>
        </nz-card>
      </div>
    }
  </div>

  <div nz-row [nzGutter]="[24, 24]">
    <!-- 左側 - 部門狀態與活動監控 -->
    <div nz-col nzXs="24" nzLg="16">
      <!-- 部門運營狀態 -->
      <nz-card [nzBordered]="false" [nzLoading]="loading" class="section-card">
        <div class="section-header">
          <div class="section-title">
            <i nz-icon nzType="apartment" nzTheme="outline"></i>
            <span>部門運營狀態</span>
          </div>
          <div class="section-legend">
            <span class="legend-item"><span class="dot excellent"></span>優秀</span>
            <span class="legend-item"><span class="dot good"></span>良好</span>
            <span class="legend-item"><span class="dot warning"></span>注意</span>
          </div>
        </div>
        <div class="dept-grid">
          @for (dept of departments; track dept.id) {
            <div class="dept-card" [style.border-left-color]="getStatusColor(dept.status)">
              <div class="dept-header">
                <span class="dept-name">{{ dept.name }}</span>
                <nz-tag [nzColor]="getStatusColor(dept.status)">{{ getStatusText(dept.status) }}</nz-tag>
              </div>
              <div class="dept-stats">
                <div class="stat-item">
                  <span class="stat-value">{{ dept.memberCount }}</span>
                  <span class="stat-label">人員</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ dept.activeProjects }}</span>
                  <span class="stat-label">項目</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ dept.completionRate }}%</span>
                  <span class="stat-label">完成率</span>
                </div>
              </div>
              <div class="dept-progress">
                <nz-progress
                  [nzPercent]="dept.completionRate"
                  [nzShowInfo]="false"
                  nzSize="small"
                  [nzStrokeColor]="getStatusColor(dept.status)"
                />
              </div>
              <div class="dept-footer">
                <span class="dept-head">
                  <i nz-icon nzType="user" nzTheme="outline"></i>
                  {{ dept.head }}
                </span>
              </div>
            </div>
          }
        </div>
      </nz-card>

      <!-- 即時活動監控 -->
      <nz-card [nzBordered]="false" class="section-card">
        <div class="section-header">
          <div class="section-title">
            <i nz-icon nzType="stock" nzTheme="outline"></i>
            <span>即時活動監控</span>
          </div>
          <div class="live-indicator">
            <span class="live-dot"></span>
            即時更新中
          </div>
        </div>
        @if (activeData) {
          <div class="activity-chart">
            <g2-mini-area [animate]="true" line [borderWidth]="2" [height]="180" [padding]="[10, 0, 20, 0]" [data]="activeData" />
          </div>
          <div class="activity-stats">
            <div class="activity-stat">
              <span class="stat-label">峰值活動</span>
              <span class="stat-value">{{ activeStat.max }}</span>
            </div>
            <div class="activity-stat">
              <span class="stat-label">平均活動</span>
              <span class="stat-value">{{ activeStat.min }}</span>
            </div>
            <div class="activity-stat">
              <span class="stat-label">當前時段</span>
              <span class="stat-value">{{ activeStat.t2 }}</span>
            </div>
          </div>
        }
      </nz-card>
    </div>

    <!-- 右側 - 告警與效率 -->
    <div nz-col nzXs="24" nzLg="8">
      <!-- 系統告警 -->
      <nz-card [nzBordered]="false" class="section-card alert-card">
        <div class="section-header">
          <div class="section-title">
            <i nz-icon nzType="alert" nzTheme="outline"></i>
            <span>系統告警</span>
          </div>
          <nz-badge [nzCount]="errorAlertCount" nzShowZero class="error-badge" />
        </div>
        <div class="alert-list">
          @for (alert of alerts; track alert.id) {
            <div class="alert-item" [class]="'alert-' + alert.type">
              <div class="alert-icon" [style.color]="getAlertColor(alert.type)">
                <i nz-icon [nzType]="getAlertIcon(alert.type)" nzTheme="fill"></i>
              </div>
              <div class="alert-content">
                <div class="alert-title">{{ alert.title }}</div>
                <div class="alert-desc">{{ alert.description }}</div>
                <div class="alert-meta">
                  <span class="alert-dept">{{ alert.department }}</span>
                  <span class="alert-time">{{ alert.time }}</span>
                </div>
              </div>
            </div>
          }
        </div>
      </nz-card>

      <!-- 運營效率 -->
      <nz-card [nzBordered]="false" class="section-card">
        <div class="section-header">
          <div class="section-title">
            <i nz-icon nzType="dashboard" nzTheme="outline"></i>
            <span>運營效率指數</span>
          </div>
        </div>
        @if (percent) {
          <div class="gauge-container">
            <g2-gauge [title]="'整體效率'" [height]="200" [percent]="percent" [format]="couponFormat" />
          </div>
        }
      </nz-card>

      <!-- 資源使用率 -->
      <nz-card [nzBordered]="false" class="section-card">
        <div class="section-header">
          <div class="section-title">
            <i nz-icon nzType="database" nzTheme="outline"></i>
            <span>資源使用率</span>
          </div>
        </div>
        <div class="water-wave-container">
          <g2-water-wave title="資源使用" [percent]="72" [height]="160" />
        </div>
      </nz-card>
    </div>
  </div>

  <!-- 底部 - 分類分析 -->
  <div nz-row [nzGutter]="[24, 24]" class="bottom-row">
    <div nz-col nzXs="24" nzLg="12">
      <nz-card [nzBordered]="false" [nzLoading]="loading" class="section-card">
        <div class="section-header">
          <div class="section-title">
            <i nz-icon nzType="pie-chart" nzTheme="outline"></i>
            <span>工程類別分佈</span>
          </div>
        </div>
        <div nz-row [nzGutter]="[16, 16]" class="pie-grid">
          <div nz-col [nzSpan]="8">
            <div class="pie-item">
              <g2-pie [animate]="false" [percent]="42" subTitle="土建工程" total="42%" [height]="128" [lineWidth]="3" />
            </div>
          </div>
          <div nz-col [nzSpan]="8">
            <div class="pie-item">
              <g2-pie [animate]="false" color="#13c2c2" [percent]="28" subTitle="機電工程" total="28%" [height]="128" [lineWidth]="3" />
            </div>
          </div>
          <div nz-col [nzSpan]="8">
            <div class="pie-item">
              <g2-pie [animate]="false" color="#722ed1" [percent]="30" subTitle="裝飾工程" total="30%" [height]="128" [lineWidth]="3" />
            </div>
          </div>
        </div>
      </nz-card>
    </div>
    <div nz-col nzXs="24" nzLg="12">
      <nz-card [nzBordered]="false" [nzLoading]="loading" class="section-card">
        <div class="section-header">
          <div class="section-title">
            <i nz-icon nzType="cloud" nzTheme="outline"></i>
            <span>熱門標籤</span>
          </div>
        </div>
        <div class="tag-cloud-container">
          <g2-tag-cloud [data]="tags" [height]="200" />
        </div>
      </nz-card>
    </div>
  </div>
</div>
