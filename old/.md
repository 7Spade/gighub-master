整個專案認證流程採用Supabase Auth → Delon Auth → DA_SERVICE_TOKEN → Angular Application的情況下 
account 用戶 組織 bot 使用type區分
組織角色 擁有者,管理者,成員
團隊=組織的子帳戶
團隊角色=團長 團隊成員
藍圖=只有用戶 組織可以建立
藍圖=實際邏輯容器
容器內包含多種模組 包括任務 日誌 儀錶板等等

數據模型設計
2.1 核心表結構
Table: accounts
用戶、組織、Bot 的統一帳戶表
sqlCREATE TYPE account_type AS ENUM ('user', 'organization', 'bot');
CREATE TYPE account_status AS ENUM ('active', 'suspended', 'deleted');

CREATE TABLE accounts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  auth_id UUID REFERENCES auth.users(id) ON DELETE CASCADE, -- Supabase Auth ID (僅 user 類型有值)
  type account_type NOT NULL,
  status account_status DEFAULT 'active',
  
  -- 基本資訊
  name TEXT NOT NULL,
  email TEXT,
  avatar_url TEXT,
  
  -- 組織專用欄位
  organization_settings JSONB DEFAULT '{}',
  
  -- Bot 專用欄位
  bot_token TEXT,
  bot_config JSONB DEFAULT '{}',
  
  -- 時間戳
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- 約束
  CONSTRAINT unique_email_per_type UNIQUE (email, type),
  CONSTRAINT user_must_have_auth_id CHECK (
    (type = 'user' AND auth_id IS NOT NULL) OR 
    (type != 'user')
  )
);

CREATE INDEX idx_accounts_auth_id ON accounts(auth_id);
CREATE INDEX idx_accounts_type ON accounts(type);
CREATE INDEX idx_accounts_email ON accounts(email);

Table: organization_members
組織成員關係表
sqlCREATE TYPE org_role AS ENUM ('owner', 'admin', 'member');

CREATE TABLE organization_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES accounts(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES accounts(id) ON DELETE CASCADE,
  role org_role NOT NULL DEFAULT 'member',
  
  -- 權限控制
  permissions JSONB DEFAULT '{}', -- 自定義權限覆蓋
  
  -- 時間戳
  joined_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- 約束
  UNIQUE(organization_id, user_id),
  CONSTRAINT org_must_be_organization CHECK (
    EXISTS (SELECT 1 FROM accounts WHERE id = organization_id AND type = 'organization')
  ),
  CONSTRAINT user_must_be_user CHECK (
    EXISTS (SELECT 1 FROM accounts WHERE id = user_id AND type = 'user')
  )
);

CREATE INDEX idx_org_members_org ON organization_members(organization_id);
CREATE INDEX idx_org_members_user ON organization_members(user_id);
CREATE INDEX idx_org_members_role ON organization_members(role);

Table: teams
團隊表(組織的子帳戶)
sqlCREATE TABLE teams (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES accounts(id) ON DELETE CASCADE,
  
  -- 基本資訊
  name TEXT NOT NULL,
  description TEXT,
  avatar_url TEXT,
  settings JSONB DEFAULT '{}',
  
  -- 時間戳
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- 約束
  UNIQUE(organization_id, name),
  CONSTRAINT org_must_be_organization CHECK (
    EXISTS (SELECT 1 FROM accounts WHERE id = organization_id AND type = 'organization')
  )
);

CREATE INDEX idx_teams_org ON teams(organization_id);

Table: team_members
團隊成員關係表
sqlCREATE TYPE team_role AS ENUM ('leader', 'member');

CREATE TABLE team_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  team_id UUID NOT NULL REFERENCES teams(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES accounts(id) ON DELETE CASCADE,
  role team_role NOT NULL DEFAULT 'member',
  
  -- 權限控制
  permissions JSONB DEFAULT '{}',
  
  -- 時間戳
  joined_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- 約束
  UNIQUE(team_id, user_id),
  CONSTRAINT user_must_be_user CHECK (
    EXISTS (SELECT 1 FROM accounts WHERE id = user_id AND type = 'user')
  ),
  CONSTRAINT user_must_be_org_member CHECK (
    EXISTS (
      SELECT 1 FROM teams t
      JOIN organization_members om ON om.organization_id = t.organization_id
      WHERE t.id = team_id AND om.user_id = team_members.user_id
    )
  )
);

CREATE INDEX idx_team_members_team ON team_members(team_id);
CREATE INDEX idx_team_members_user ON team_members(user_id);

Table: blueprints
藍圖表(邏輯容器)
sqlCREATE TYPE blueprint_status AS ENUM ('draft', 'active', 'archived');
CREATE TYPE blueprint_owner_type AS ENUM ('user', 'organization');

CREATE TABLE blueprints (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- 所有者資訊
  owner_id UUID NOT NULL REFERENCES accounts(id) ON DELETE CASCADE,
  owner_type blueprint_owner_type NOT NULL,
  
  -- 基本資訊
  name TEXT NOT NULL,
  description TEXT,
  status blueprint_status DEFAULT 'draft',
  
  -- 配置
  config JSONB DEFAULT '{}',
  metadata JSONB DEFAULT '{}',
  
  -- 時間戳
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- 約束
  CONSTRAINT owner_type_matches CHECK (
    (owner_type = 'user' AND EXISTS (SELECT 1 FROM accounts WHERE id = owner_id AND type = 'user')) OR
    (owner_type = 'organization' AND EXISTS (SELECT 1 FROM accounts WHERE id = owner_id AND type = 'organization'))
  )
);

CREATE INDEX idx_blueprints_owner ON blueprints(owner_id);
CREATE INDEX idx_blueprints_status ON blueprints(status);

Table: blueprint_permissions
藍圖權限共享表
sqlCREATE TYPE permission_level AS ENUM ('read', 'write', 'admin');
CREATE TYPE permission_target_type AS ENUM ('user', 'team', 'organization');

CREATE TABLE blueprint_permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  blueprint_id UUID NOT NULL REFERENCES blueprints(id) ON DELETE CASCADE,
  
  -- 授權目標
  target_id UUID NOT NULL REFERENCES accounts(id) ON DELETE CASCADE,
  target_type permission_target_type NOT NULL,
  
  -- 權限等級
  permission permission_level NOT NULL DEFAULT 'read',
  
  -- 時間戳
  granted_at TIMESTAMPTZ DEFAULT NOW(),
  granted_by UUID REFERENCES accounts(id),
  
  -- 約束
  UNIQUE(blueprint_id, target_id, target_type)
);

CREATE INDEX idx_blueprint_perms_blueprint ON blueprint_permissions(blueprint_id);
CREATE INDEX idx_blueprint_perms_target ON blueprint_permissions(target_id);

2.2 模組表結構
Table: modules
模組基礎表
sqlCREATE TYPE module_type AS ENUM ('task', 'log', 'dashboard', 'custom');

CREATE TABLE modules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  blueprint_id UUID NOT NULL REFERENCES blueprints(id) ON DELETE CASCADE,
  type module_type NOT NULL,
  
  -- 基本資訊
  name TEXT NOT NULL,
  description TEXT,
  config JSONB DEFAULT '{}',
  
  -- 時間戳
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_modules_blueprint ON modules(blueprint_id);
CREATE INDEX idx_modules_type ON modules(type);

Table: tasks
任務模組
sqlCREATE TYPE task_status AS ENUM ('todo', 'in_progress', 'review', 'done', 'cancelled');
CREATE TYPE task_priority AS ENUM ('low', 'medium', 'high', 'urgent');

CREATE TABLE tasks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  module_id UUID NOT NULL REFERENCES modules(id) ON DELETE CASCADE,
  
  -- 任務資訊
  title TEXT NOT NULL,
  description TEXT,
  status task_status DEFAULT 'todo',
  priority task_priority DEFAULT 'medium',
  
  -- 指派
  assigned_to UUID REFERENCES accounts(id),
  
  -- 時間
  due_date TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  
  -- 額外資料
  tags TEXT[] DEFAULT '{}',
  metadata JSONB DEFAULT '{}',
  
  -- 時間戳
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES accounts(id)
);

CREATE INDEX idx_tasks_module ON tasks(module_id);
CREATE INDEX idx_tasks_assigned ON tasks(assigned_to);
CREATE INDEX idx_tasks_status ON tasks(status);

Table: logs
日誌模組
sqlCREATE TYPE log_level AS ENUM ('debug', 'info', 'warning', 'error', 'critical');

CREATE TABLE logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  module_id UUID NOT NULL REFERENCES modules(id) ON DELETE CASCADE,
  
  -- 日誌資訊
  level log_level NOT NULL DEFAULT 'info',
  message TEXT NOT NULL,
  details JSONB DEFAULT '{}',
  
  -- 來源
  source TEXT,
  user_id UUID REFERENCES accounts(id),
  
  -- 時間戳
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_logs_module ON logs(module_id);
CREATE INDEX idx_logs_level ON logs(level);
CREATE INDEX idx_logs_created ON logs(created_at DESC);

Table: dashboards
儀錶板模組
sqlCREATE TABLE dashboards (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  module_id UUID NOT NULL REFERENCES modules(id) ON DELETE CASCADE,
  
  -- 儀錶板資訊
  name TEXT NOT NULL,
  layout JSONB NOT NULL DEFAULT '[]', -- 佈局配置
  widgets JSONB NOT NULL DEFAULT '[]', -- 小部件配置
  
  -- 時間戳
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_dashboards_module ON dashboards(module_id);

3. RLS 安全策略設計
3.1 啟用 RLS
sql-- 為所有表啟用 RLS
ALTER TABLE accounts ENABLE ROW LEVEL SECURITY;
ALTER TABLE organization_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE teams ENABLE ROW LEVEL SECURITY;
ALTER TABLE team_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE blueprints ENABLE ROW LEVEL SECURITY;
ALTER TABLE blueprint_permissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE modules ENABLE ROW LEVEL SECURITY;
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE dashboards ENABLE ROW LEVEL SECURITY;

3.2 輔助函數
sql-- 獲取當前用戶的 account_id
CREATE OR REPLACE FUNCTION get_current_account_id()
RETURNS UUID AS $$
  SELECT id FROM accounts WHERE auth_id = auth.uid();
$$ LANGUAGE SQL SECURITY DEFINER;

-- 檢查是否為組織擁有者
CREATE OR REPLACE FUNCTION is_org_owner(org_id UUID)
RETURNS BOOLEAN AS $$
  SELECT EXISTS (
    SELECT 1 FROM organization_members
    WHERE organization_id = org_id
    AND user_id = get_current_account_id()
    AND role = 'owner'
  );
$$ LANGUAGE SQL SECURITY DEFINER;

-- 檢查是否為組織管理者或擁有者
CREATE OR REPLACE FUNCTION is_org_admin_or_owner(org_id UUID)
RETURNS BOOLEAN AS $$
  SELECT EXISTS (
    SELECT 1 FROM organization_members
    WHERE organization_id = org_id
    AND user_id = get_current_account_id()
    AND role IN ('owner', 'admin')
  );
$$ LANGUAGE SQL SECURITY DEFINER;

-- 檢查是否為組織成員
CREATE OR REPLACE FUNCTION is_org_member(org_id UUID)
RETURNS BOOLEAN AS $$
  SELECT EXISTS (
    SELECT 1 FROM organization_members
    WHERE organization_id = org_id
    AND user_id = get_current_account_id()
  );
$$ LANGUAGE SQL SECURITY DEFINER;

-- 檢查是否為團隊團長
CREATE OR REPLACE FUNCTION is_team_leader(team_id UUID)
RETURNS BOOLEAN AS $$
  SELECT EXISTS (
    SELECT 1 FROM team_members
    WHERE team_id = team_id
    AND user_id = get_current_account_id()
    AND role = 'leader'
  );
$$ LANGUAGE SQL SECURITY DEFINER;

-- 檢查藍圖權限
CREATE OR REPLACE FUNCTION has_blueprint_permission(
  blueprint_id UUID,
  required_permission permission_level
)
RETURNS BOOLEAN AS $$
DECLARE
  current_user_id UUID := get_current_account_id();
  blueprint_owner UUID;
  blueprint_owner_type blueprint_owner_type;
BEGIN
  -- 獲取藍圖所有者資訊
  SELECT owner_id, owner_type INTO blueprint_owner, blueprint_owner_type
  FROM blueprints WHERE id = blueprint_id;
  
  -- 檢查是否為藍圖擁有者
  IF blueprint_owner = current_user_id THEN
    RETURN TRUE;
  END IF;
  
  -- 檢查直接權限
  IF EXISTS (
    SELECT 1 FROM blueprint_permissions
    WHERE blueprint_permissions.blueprint_id = has_blueprint_permission.blueprint_id
    AND target_id = current_user_id
    AND target_type = 'user'
    AND (
      (required_permission = 'read') OR
      (required_permission = 'write' AND permission IN ('write', 'admin')) OR
      (required_permission = 'admin' AND permission = 'admin')
    )
  ) THEN
    RETURN TRUE;
  END IF;
  
  -- 檢查組織權限
  IF blueprint_owner_type = 'organization' AND is_org_member(blueprint_owner) THEN
    RETURN TRUE;
  END IF;
  
  -- 檢查團隊權限
  IF EXISTS (
    SELECT 1 FROM blueprint_permissions bp
    JOIN team_members tm ON tm.team_id = bp.target_id
    WHERE bp.blueprint_id = has_blueprint_permission.blueprint_id
    AND bp.target_type = 'team'
    AND tm.user_id = current_user_id
    AND (
      (required_permission = 'read') OR
      (required_permission = 'write' AND bp.permission IN ('write', 'admin')) OR
      (required_permission = 'admin' AND bp.permission = 'admin')
    )
  ) THEN
    RETURN TRUE;
  END IF;
  
  RETURN FALSE;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

3.3 RLS 策略
Accounts 表
sql-- 用戶可以查看自己的帳戶
CREATE POLICY "Users can view own account"
ON accounts FOR SELECT
USING (auth_id = auth.uid());

-- 用戶可以查看所屬組織
CREATE POLICY "Users can view their organizations"
ON accounts FOR SELECT
USING (
  type = 'organization' AND
  EXISTS (
    SELECT 1 FROM organization_members
    WHERE organization_id = accounts.id
    AND user_id = get_current_account_id()
  )
);

-- 用戶可以更新自己的帳戶
CREATE POLICY "Users can update own account"
ON accounts FOR UPDATE
USING (auth_id = auth.uid())
WITH CHECK (auth_id = auth.uid());

-- 組織擁有者可以更新組織資訊
CREATE POLICY "Owners can update organization"
ON accounts FOR UPDATE
USING (type = 'organization' AND is_org_owner(id))
WITH CHECK (type = 'organization' AND is_org_owner(id));

Organization Members 表
sql-- 組織成員可以查看同組織成員
CREATE POLICY "Members can view org members"
ON organization_members FOR SELECT
USING (is_org_member(organization_id));

-- 管理者可以新增成員
CREATE POLICY "Admins can insert members"
ON organization_members FOR INSERT
WITH CHECK (is_org_admin_or_owner(organization_id));

-- 管理者可以更新成員
CREATE POLICY "Admins can update members"
ON organization_members FOR UPDATE
USING (is_org_admin_or_owner(organization_id))
WITH CHECK (is_org_admin_or_owner(organization_id));

-- 擁有者可以刪除成員,管理者可以刪除普通成員
CREATE POLICY "Owners can delete members"
ON organization_members FOR DELETE
USING (
  is_org_owner(organization_id) OR
  (is_org_admin_or_owner(organization_id) AND role = 'member')
);

Teams 表
sql-- 組織成員可以查看團隊
CREATE POLICY "Org members can view teams"
ON teams FOR SELECT
USING (is_org_member(organization_id));

-- 管理者可以創建團隊
CREATE POLICY "Admins can create teams"
ON teams FOR INSERT
WITH CHECK (is_org_admin_or_owner(organization_id));

-- 管理者可以更新團隊
CREATE POLICY "Admins can update teams"
ON teams FOR UPDATE
USING (is_org_admin_or_owner(organization_id))
WITH CHECK (is_org_admin_or_owner(organization_id));

-- 管理者可以刪除團隊
CREATE POLICY "Admins can delete teams"
ON teams FOR DELETE
USING (is_org_admin_or_owner(organization_id));

Team Members 表
sql-- 團隊成員可以查看同團隊成員
CREATE POLICY "Team members can view members"
ON team_members FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM team_members tm
    WHERE tm.team_id = team_members.team_id
    AND tm.user_id = get_current_account_id()
  )
);

-- 團長和組織管理者可以新增成員
CREATE POLICY "Leaders can insert members"
ON team_members FOR INSERT
WITH CHECK (
  is_team_leader(team_id) OR
  EXISTS (
    SELECT 1 FROM teams
    WHERE id = team_id
    AND is_org_admin_or_owner(organization_id)
  )
);

-- 團長和組織管理者可以更新成員
CREATE POLICY "Leaders can update members"
ON team_members FOR UPDATE
USING (
  is_team_leader(team_id) OR
  EXISTS (
    SELECT 1 FROM teams
    WHERE id = team_id
    AND is_org_admin_or_owner(organization_id)
  )
)
WITH CHECK (
  is_team_leader(team_id) OR
  EXISTS (
    SELECT 1 FROM teams
    WHERE id = team_id
    AND is_org_admin_or_owner(organization_id)
  )
);

-- 團長和組織管理者可以刪除成員
CREATE POLICY "Leaders can delete members"
ON team_members FOR DELETE
USING (
  is_team_leader(team_id) OR
  EXISTS (
    SELECT 1 FROM teams
    WHERE id = team_id
    AND is_org_admin_or_owner(organization_id)
  )
);

Blueprints 表
sql-- 用戶可以查看自己擁有的藍圖
CREATE POLICY "Users can view own blueprints"
ON blueprints FOR SELECT
USING (owner_id = get_current_account_id());

-- 用戶可以查看有權限的藍圖
CREATE POLICY "Users can view shared blueprints"
ON blueprints FOR SELECT
USING (has_blueprint_permission(id, 'read'));

-- 用戶可以創建個人藍圖
CREATE POLICY "Users can create own blueprints"
ON blueprints FOR INSERT
WITH CHECK (
  owner_id = get_current_account_id() AND
  owner_type = 'user'
);

-- 組織管理者可以創建組織藍圖
CREATE POLICY "Admins can create org blueprints"
ON blueprints FOR INSERT
WITH CHECK (
  owner_type = 'organization' AND
  is_org_admin_or_owner(owner_id)
);

-- 擁有者可以更新藍圖
CREATE POLICY "Owners can update blueprints"
ON blueprints FOR UPDATE
USING (owner_id = get_current_account_id())
WITH CHECK (owner_id = get_current_account_id());

-- 有管理權限的用戶可以更新藍圖
CREATE POLICY "Admins can update blueprints"
ON blueprints FOR UPDATE
USING (has_blueprint_permission(id, 'admin'))
WITH CHECK (has_blueprint_permission(id, 'admin'));

-- 擁有者可以刪除藍圖
CREATE POLICY "Owners can delete blueprints"
ON blueprints FOR DELETE
USING (owner_id = get_current_account_id());

Modules 表
sql-- 有讀取權限可以查看模組
CREATE POLICY "Users can view modules"
ON modules FOR SELECT
USING (has_blueprint_permission(blueprint_id, 'read'));

-- 有寫入權限可以創建模組
CREATE POLICY "Users can create modules"
ON modules FOR INSERT
WITH CHECK (has_blueprint_permission(blueprint_id, 'write'));

-- 有寫入權限可以更新模組
CREATE POLICY "Users can update modules"
ON modules FOR UPDATE
USING (has_blueprint_permission(blueprint_id, 'write'))
WITH CHECK (has_blueprint_permission(blueprint_id, 'write'));

-- 有管理權限可以刪除模組
CREATE POLICY "Admins can delete modules"
ON modules FOR DELETE
USING (has_blueprint_permission(blueprint_id, 'admin'));

Tasks 表
sql-- 有讀取權限可以查看任務
CREATE POLICY "Users can view tasks"
ON tasks FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM modules
    WHERE modules.id = tasks.module_id
    AND has_blueprint_permission(modules.blueprint_id, 'read')
  )
);

-- 有寫入權限可以創建任務
CREATE POLICY "Users can create tasks"
ON tasks FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1 FROM modules
    WHERE modules.id = tasks.module_id
    AND has_blueprint_permission(modules.blueprint_id, 'write')
  )
);

-- 有寫入權限可以更新任務
CREATE POLICY "Users can update tasks"
ON tasks FOR UPDATE
USING (
  EXISTS (
    SELECT 1 FROM modules
    WHERE modules.id = tasks.module_id
    AND has_blueprint_permission(modules.blueprint_id, 'write')
  )
)
WITH CHECK (
  EXISTS (
    SELECT 1 FROM modules
    WHERE modules.id = tasks.module_id
    AND has_blueprint_permission(modules.blueprint_id, 'write')
  )
);

-- 有管理權限可以刪除任務
CREATE POLICY "Admins can delete tasks"
ON tasks FOR DELETE
USING (
  EXISTS (
    SELECT 1 FROM modules
    WHERE modules.id = tasks.module_id
    AND has_blueprint_permission(modules.blueprint_id, 'admin')
  )
);

Logs 表
sql-- 有讀取權限可以查看日誌
CREATE POLICY "Users can view logs"
ON logs FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM modules
    WHERE modules.id = logs.module_id
    AND has_blueprint_permission(modules.blueprint_id, 'read')
  )
);

-- 有寫入權限可以創建日誌
CREATE POLICY "Users can create logs"
ON logs FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1 FROM modules
    WHERE modules.id = logs.module_id
    AND has_blueprint_permission(modules.blueprint_id, 'write')
  )
);

-- 日誌不可更新(僅追加)
-- 有管理權限可以刪除日誌
CREATE POLICY "Admins can delete logs"
ON logs FOR DELETE
USING (
  EXISTS (
    SELECT 1 FROM modules
    WHERE modules.id = logs.module_id
    AND has_blueprint_permission(modules.blueprint_id, 'admin')
  )
);