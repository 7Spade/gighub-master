<!--
  Task Tree Component Template
  
  Displays tasks in tree structure with simplified information:
  - Status badges
  - Priority
  - Task title
  - Completion rate
  - Assignee avatar
  - Actions
  Aligned with database schema: 20251129000001_create_multi_tenant_saas_schema.sql
-->

@if (rootTasks().length === 0) {
  <nz-empty [nzNotFoundContent]="'暫無任務'"></nz-empty>
} @else {
  <nz-tree-view [nzTreeControl]="treeControl" [nzDataSource]="dataSource" class="task-tree">
    <nz-tree-node *nzTreeNodeDef="let node" nzTreeNodePadding>
      <nz-tree-node-toggle nzTreeNodeNoopToggle></nz-tree-node-toggle>
      <ng-container [ngTemplateOutlet]="nodeContent" [ngTemplateOutletContext]="{ $implicit: node }"></ng-container>
    </nz-tree-node>

    <nz-tree-node *nzTreeNodeDef="let node; when: hasChild" nzTreeNodePadding>
      <nz-tree-node-toggle>
        <span nz-icon [nzType]="treeControl.isExpanded(node) ? 'minus-square' : 'plus-square'"></span>
      </nz-tree-node-toggle>
      <ng-container [ngTemplateOutlet]="nodeContent" [ngTemplateOutletContext]="{ $implicit: node }"></ng-container>
    </nz-tree-node>
  </nz-tree-view>
}

<!-- Node Content Template -->
<ng-template #nodeContent let-node>
  <div class="tree-node-content" (click)="onNodeClick(node)">
    <!-- Priority Badge -->
    <nz-tag [nzColor]="getPriorityColor(node.priority)" class="priority-tag">
      {{ getPriorityText(node.priority) }}
    </nz-tag>

    <!-- Status Badge -->
    <nz-badge [nzStatus]="getStatusColor(node.status)" [nzText]="getStatusText(node.status)"></nz-badge>

    <!-- Task Title -->
    <span class="task-name" [class.completed]="node.status === 'completed'">
      {{ node.title }}
    </span>

    <!-- Child Count -->
    @if (node.expandable) {
      <nz-tag nzColor="default" class="child-count">
        {{ node.childCount }} 子任務
      </nz-tag>
    }

    <!-- Completion Rate Progress Bar -->
    <div class="progress-wrapper">
      <nz-progress 
        [nzPercent]="node.completionRate" 
        [nzSize]="'small'"
        [nzStatus]="getProgressStatus(node.completionRate)"
        [nzShowInfo]="true">
      </nz-progress>
    </div>

    <!-- Assignee -->
    @if (node.assigneeId) {
      <nz-avatar 
        [nzText]="formatAssigneeInitials(node.assigneeId)"
        nzSize="small"
        nz-tooltip
        [nzTooltipTitle]="node.assigneeId">
      </nz-avatar>
    }

    <!-- Actions -->
    <div class="node-actions">
      <button nz-button nzType="text" nzSize="small" (click)="onEdit($event, node)" nz-tooltip nzTooltipTitle="編輯">
        <i nz-icon nzType="edit" nzTheme="outline"></i>
      </button>
      <button nz-button nzType="text" nzSize="small" nzDanger (click)="onDelete($event, node)" nz-tooltip nzTooltipTitle="刪除">
        <i nz-icon nzType="delete" nzTheme="outline"></i>
      </button>
    </div>
  </div>
</ng-template>
