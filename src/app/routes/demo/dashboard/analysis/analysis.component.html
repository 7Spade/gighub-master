<!-- 財務分析儀表板 -->
<div class="finance-dashboard">
  <!-- 頂部標題區 -->
  <div class="dashboard-header">
    <div class="header-content">
      <div class="header-left">
        <div class="header-icon">
          <i nz-icon nzType="fund" nzTheme="outline"></i>
        </div>
        <div class="header-text">
          <h1>財務分析中心</h1>
          <p>實時追蹤預算執行、現金流動與財務健康狀況</p>
        </div>
      </div>
      <div class="header-right">
        <div class="date-filter">
          @for (t of dateRangeTypes; track $index) {
            <span class="date-item" [class.active]="dateRangeType === t" (click)="setDate(t)">
              {{ 'app.analysis.all-' + t | i18n }}
            </span>
          }
        </div>
        <nz-range-picker [(ngModel)]="dateRange" class="date-picker" />
      </div>
    </div>
  </div>

  <!-- 財務指標卡片 -->
  <div nz-row [nzGutter]="[24, 24]" class="stat-row">
    @for (stat of financialStats; track $index) {
      <div nz-col nzXs="24" nzSm="12" nzMd="12" nzLg="6">
        <nz-card [nzBordered]="false" class="stat-card" [class]="'stat-card-' + stat.color">
          <div class="stat-card-body">
            <div class="stat-icon">
              <i nz-icon [nzType]="stat.icon" nzTheme="outline"></i>
            </div>
            <div class="stat-content">
              <span class="stat-title">{{ stat.title }}</span>
              <div class="stat-value">
                <span class="prefix">{{ stat.prefix }}</span>
                <span class="number">{{ stat.value | number }}</span>
                <span class="suffix">{{ stat.suffix }}</span>
              </div>
              <div class="stat-trend">
                <trend [flag]="stat.trend">
                  {{ stat.trend === 'up' ? '↑' : '↓' }} {{ stat.trendValue }}%
                </trend>
                <span class="trend-text">較上月</span>
              </div>
            </div>
          </div>
        </nz-card>
      </div>
    }
  </div>

  <!-- 主內容區 -->
  <div nz-row [nzGutter]="[24, 24]">
    <!-- 左側 - 預算執行與現金流 -->
    <div nz-col nzXs="24" nzLg="16">
      <!-- 預算執行情況 -->
      <nz-card [nzLoading]="loading" [nzBordered]="false" class="section-card">
        <div class="section-header">
          <div class="section-title">
            <i nz-icon nzType="pie-chart" nzTheme="outline"></i>
            <span>預算執行情況</span>
          </div>
          <div class="section-extra">
            <span class="total-label">總預算：</span>
            <span class="total-value">¥2,850,000</span>
          </div>
        </div>
        <div class="budget-grid">
          @for (category of budgetCategories; track $index) {
            <div class="budget-item">
              <div class="budget-header">
                <span class="budget-name">{{ category.name }}</span>
                <span class="budget-values">
                  <span class="spent">¥{{ category.spent | number }}</span>
                  <span class="divider">/</span>
                  <span class="budget">¥{{ category.budget | number }}</span>
                </span>
              </div>
              <div class="budget-progress">
                <nz-progress
                  [nzPercent]="getBudgetRate(category)"
                  [nzStrokeColor]="getBudgetStatusColor(category.status)"
                  [nzShowInfo]="true"
                  nzSize="small"
                />
              </div>
            </div>
          }
        </div>
      </nz-card>

      <!-- 現金流趨勢 -->
      <nz-card [nzLoading]="loading" [nzBordered]="false" class="section-card">
        <div class="section-header">
          <div class="section-title">
            <i nz-icon nzType="line-chart" nzTheme="outline"></i>
            <span>現金流趨勢</span>
          </div>
          <nz-radio-group [(ngModel)]="cashFlowType" (ngModelChange)="changeCashFlowType()" nzButtonStyle="solid" nzSize="small">
            <label nz-radio-button nzValue="month">本月</label>
            <label nz-radio-button nzValue="quarter">本季</label>
            <label nz-radio-button nzValue="year">本年</label>
          </nz-radio-group>
        </div>
        @if (data.offlineChartData) {
          <g2-timeline [data]="data.offlineChartData" [titleMap]="titleMap" [height]="300" />
        }
      </nz-card>
    </div>

    <!-- 右側 - 支出分析與待付款項 -->
    <div nz-col nzXs="24" nzLg="8">
      <!-- 支出分佈 -->
      <nz-card [nzLoading]="loading" [nzBordered]="false" class="section-card">
        <div class="section-header">
          <div class="section-title">
            <i nz-icon nzType="fund" nzTheme="outline"></i>
            <span>支出分佈</span>
          </div>
        </div>
        @if (salesPieData) {
          <g2-pie
            [data]="salesPieData"
            [hasLegend]="true"
            subTitle="本月總支出"
            [height]="248"
            [lineWidth]="3"
            [total]="salesTotal"
            [valueFormat]="handlePieValueFormat"
          />
        }
      </nz-card>

      <!-- 待付款項 -->
      <nz-card [nzBordered]="false" class="section-card pending-card">
        <div class="section-header">
          <div class="section-title">
            <i nz-icon nzType="clock-circle" nzTheme="outline"></i>
            <span>待付款項</span>
          </div>
          <nz-badge [nzCount]="pendingPayments.length" nzShowZero />
        </div>
        <div class="pending-list">
          @for (payment of pendingPayments; track payment.id) {
            <div class="pending-item" [class.urgent]="payment.priority === 'high'">
              <div class="pending-header">
                <span class="pending-id">{{ payment.id }}</span>
                <nz-tag [nzColor]="getPriorityColor(payment.priority)">
                  {{ payment.priority === 'high' ? '緊急' : payment.priority === 'medium' ? '一般' : '低' }}
                </nz-tag>
              </div>
              <div class="pending-body">
                <div class="pending-project">{{ payment.project }}</div>
                <div class="pending-vendor">{{ payment.vendor }}</div>
              </div>
              <div class="pending-footer">
                <span class="pending-amount">¥{{ payment.amount | number }}</span>
                <span class="pending-due">
                  <i nz-icon nzType="calendar" nzTheme="outline"></i>
                  {{ payment.dueDate }}
                </span>
              </div>
            </div>
          }
        </div>
        <div class="pending-action">
          <button nz-button nzType="dashed" nzBlock (click)="msg.info('查看全部待付款項')">
            <i nz-icon nzType="plus" nzTheme="outline"></i>
            查看全部
          </button>
        </div>
      </nz-card>
    </div>
  </div>

  <!-- 底部 - 財務報表趨勢 -->
  <nz-card [nzLoading]="loading" [nzBordered]="false" class="section-card chart-card">
    <div class="section-header">
      <div class="section-title">
        <i nz-icon nzType="bar-chart" nzTheme="outline"></i>
        <span>月度財務趨勢</span>
      </div>
    </div>
    @if (data.salesData) {
      <g2-bar [data]="data.salesData" height="280" />
    }
  </nz-card>

  <!-- 工區財務明細 -->
  @if (data.offlineData) {
    <nz-card [nzLoading]="loading" [nzBordered]="false" class="section-card offline-card">
      <div class="section-header">
        <div class="section-title">
          <i nz-icon nzType="apartment" nzTheme="outline"></i>
          <span>工區財務明細</span>
        </div>
      </div>
      <nz-tabs [(nzSelectedIndex)]="offlineIdx" (nzSelectedIndexChange)="offlineChange($event)">
        @for (tab of data.offlineData; track $index) {
          <nz-tab [nzTitle]="nzTabHeading">
            <ng-template #nzTabHeading>
              <div class="tab-header">
                <span class="tab-name">{{ tab.name }}</span>
                <span class="tab-rate">{{ (tab.cvr * 100).toFixed(1) }}%</span>
              </div>
            </ng-template>
            <ng-template nz-tab>
              <div class="tab-content">
                <g2-timeline [data]="tab.chart" [titleMap]="titleMap" [height]="280" />
              </div>
            </ng-template>
          </nz-tab>
        }
      </nz-tabs>
    </nz-card>
  }
</div>
